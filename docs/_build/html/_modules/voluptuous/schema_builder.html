<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>voluptuous.schema_builder &mdash; Voluptuous 0.8.11 documentation</title>
    
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.8.11',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="Voluptuous 0.8.11 documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for voluptuous.schema_builder</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">wraps</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">contextmanager</span>

<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">from</span> <span class="nn">voluptuous</span> <span class="kn">import</span> <span class="n">error</span> <span class="k">as</span> <span class="n">er</span>

<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,):</span>
    <span class="nb">long</span> <span class="o">=</span> <span class="nb">int</span>
    <span class="nb">unicode</span> <span class="o">=</span> <span class="nb">str</span>
    <span class="nb">basestring</span> <span class="o">=</span> <span class="nb">str</span>
    <span class="n">ifilter</span> <span class="o">=</span> <span class="nb">filter</span>

    <span class="k">def</span> <span class="nf">iteritems</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
<span class="k">else</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">ifilter</span>

<div class="viewcode-block" id="iteritems"><a class="viewcode-back" href="../../voluptuous.html#voluptuous.schema_builder.iteritems">[docs]</a>    <span class="k">def</span> <span class="nf">iteritems</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">d</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()</span></div>

<span class="sd">&quot;&quot;&quot;Schema validation for Python data structures.</span>

<span class="sd">Given eg. a nested data structure like this:</span>

<span class="sd">    {</span>
<span class="sd">        &#39;exclude&#39;: [&#39;Users&#39;, &#39;Uptime&#39;],</span>
<span class="sd">        &#39;include&#39;: [],</span>
<span class="sd">        &#39;set&#39;: {</span>
<span class="sd">            &#39;snmp_community&#39;: &#39;public&#39;,</span>
<span class="sd">            &#39;snmp_timeout&#39;: 15,</span>
<span class="sd">            &#39;snmp_version&#39;: &#39;2c&#39;,</span>
<span class="sd">        },</span>
<span class="sd">        &#39;targets&#39;: {</span>
<span class="sd">            &#39;localhost&#39;: {</span>
<span class="sd">                &#39;exclude&#39;: [&#39;Uptime&#39;],</span>
<span class="sd">                &#39;features&#39;: {</span>
<span class="sd">                    &#39;Uptime&#39;: {</span>
<span class="sd">                        &#39;retries&#39;: 3,</span>
<span class="sd">                    },</span>
<span class="sd">                    &#39;Users&#39;: {</span>
<span class="sd">                        &#39;snmp_community&#39;: &#39;monkey&#39;,</span>
<span class="sd">                        &#39;snmp_port&#39;: 15,</span>
<span class="sd">                    },</span>
<span class="sd">                },</span>
<span class="sd">                &#39;include&#39;: [&#39;Users&#39;],</span>
<span class="sd">                &#39;set&#39;: {</span>
<span class="sd">                    &#39;snmp_community&#39;: &#39;monkeys&#39;,</span>
<span class="sd">                },</span>
<span class="sd">            },</span>
<span class="sd">        },</span>
<span class="sd">    }</span>

<span class="sd">A schema like this:</span>

<span class="sd">    &gt;&gt;&gt; settings = {</span>
<span class="sd">    ...   &#39;snmp_community&#39;: str,</span>
<span class="sd">    ...   &#39;retries&#39;: int,</span>
<span class="sd">    ...   &#39;snmp_version&#39;: All(Coerce(str), Any(&#39;3&#39;, &#39;2c&#39;, &#39;1&#39;)),</span>
<span class="sd">    ... }</span>
<span class="sd">    &gt;&gt;&gt; features = [&#39;Ping&#39;, &#39;Uptime&#39;, &#39;Http&#39;]</span>
<span class="sd">    &gt;&gt;&gt; schema = Schema({</span>
<span class="sd">    ...    &#39;exclude&#39;: features,</span>
<span class="sd">    ...    &#39;include&#39;: features,</span>
<span class="sd">    ...    &#39;set&#39;: settings,</span>
<span class="sd">    ...    &#39;targets&#39;: {</span>
<span class="sd">    ...      &#39;exclude&#39;: features,</span>
<span class="sd">    ...      &#39;include&#39;: features,</span>
<span class="sd">    ...      &#39;features&#39;: {</span>
<span class="sd">    ...        str: settings,</span>
<span class="sd">    ...      },</span>
<span class="sd">    ...    },</span>
<span class="sd">    ... })</span>

<span class="sd">Validate like so:</span>

<span class="sd">    &gt;&gt;&gt; schema({</span>
<span class="sd">    ...   &#39;set&#39;: {</span>
<span class="sd">    ...     &#39;snmp_community&#39;: &#39;public&#39;,</span>
<span class="sd">    ...     &#39;snmp_version&#39;: &#39;2c&#39;,</span>
<span class="sd">    ...   },</span>
<span class="sd">    ...   &#39;targets&#39;: {</span>
<span class="sd">    ...     &#39;exclude&#39;: [&#39;Ping&#39;],</span>
<span class="sd">    ...     &#39;features&#39;: {</span>
<span class="sd">    ...       &#39;Uptime&#39;: {&#39;retries&#39;: 3},</span>
<span class="sd">    ...       &#39;Users&#39;: {&#39;snmp_community&#39;: &#39;monkey&#39;},</span>
<span class="sd">    ...     },</span>
<span class="sd">    ...   },</span>
<span class="sd">    ... }) == {</span>
<span class="sd">    ...   &#39;set&#39;: {&#39;snmp_version&#39;: &#39;2c&#39;, &#39;snmp_community&#39;: &#39;public&#39;},</span>
<span class="sd">    ...   &#39;targets&#39;: {</span>
<span class="sd">    ...     &#39;exclude&#39;: [&#39;Ping&#39;],</span>
<span class="sd">    ...     &#39;features&#39;: {&#39;Uptime&#39;: {&#39;retries&#39;: 3},</span>
<span class="sd">    ...                  &#39;Users&#39;: {&#39;snmp_community&#39;: &#39;monkey&#39;}}}}</span>
<span class="sd">    True</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># options for extra keys</span>
<span class="n">PREVENT_EXTRA</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># any extra key not in schema will raise an error</span>
<span class="n">ALLOW_EXTRA</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># extra keys not in schema will be included in output</span>
<span class="n">REMOVE_EXTRA</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># extra keys not in schema will be excluded from output</span>


<span class="k">def</span> <span class="nf">_isnamedtuple</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;_fields&#39;</span><span class="p">)</span>


<span class="n">primitive_types</span> <span class="o">=</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">,</span> <span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span>


<div class="viewcode-block" id="Undefined"><a class="viewcode-back" href="../../voluptuous.html#voluptuous.schema_builder.Undefined">[docs]</a><span class="k">class</span> <span class="nc">Undefined</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__nonzero__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;...&#39;</span></div>


<span class="n">UNDEFINED</span> <span class="o">=</span> <span class="n">Undefined</span><span class="p">()</span>


<div class="viewcode-block" id="Self"><a class="viewcode-back" href="../../voluptuous.html#voluptuous.schema_builder.Self">[docs]</a><span class="k">def</span> <span class="nf">Self</span><span class="p">():</span>
    <span class="k">raise</span> <span class="n">er</span><span class="o">.</span><span class="n">SchemaError</span><span class="p">(</span><span class="s1">&#39;&quot;Self&quot; should never be called&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="default_factory"><a class="viewcode-back" href="../../voluptuous.html#voluptuous.schema_builder.default_factory">[docs]</a><span class="k">def</span> <span class="nf">default_factory</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="n">UNDEFINED</span> <span class="ow">or</span> <span class="nb">callable</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">value</span>
    <span class="k">return</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">value</span></div>


<span class="nd">@contextmanager</span>
<div class="viewcode-block" id="raises"><a class="viewcode-back" href="../../voluptuous.html#voluptuous.schema_builder.raises">[docs]</a><span class="k">def</span> <span class="nf">raises</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">yield</span>
    <span class="k">except</span> <span class="n">exc</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">msg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="o">==</span> <span class="n">msg</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%r</span><span class="s1"> != </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="n">msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">regex</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">regex</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)),</span> <span class="s1">&#39;</span><span class="si">%r</span><span class="s1"> does not match </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="n">regex</span><span class="p">)</span></div>


<div class="viewcode-block" id="Extra"><a class="viewcode-back" href="../../voluptuous.html#voluptuous.schema_builder.Extra">[docs]</a><span class="k">def</span> <span class="nf">Extra</span><span class="p">(</span><span class="n">_</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Allow keys in the data that are not present in the schema.&quot;&quot;&quot;</span>
    <span class="k">raise</span> <span class="n">er</span><span class="o">.</span><span class="n">SchemaError</span><span class="p">(</span><span class="s1">&#39;&quot;Extra&quot; should never be called&#39;</span><span class="p">)</span></div>


<span class="c1"># As extra() is never called there&#39;s no way to catch references to the</span>
<span class="c1"># deprecated object, so we just leave an alias here instead.</span>
<span class="n">extra</span> <span class="o">=</span> <span class="n">Extra</span>


<div class="viewcode-block" id="Schema"><a class="viewcode-back" href="../../voluptuous.html#voluptuous.schema_builder.Schema">[docs]</a><span class="k">class</span> <span class="nc">Schema</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A validation schema.</span>

<span class="sd">    The schema is a Python tree-like structure where nodes are pattern</span>
<span class="sd">    matched against corresponding trees of values.</span>

<span class="sd">    Nodes can be values, in which case a direct comparison is used, types,</span>
<span class="sd">    in which case an isinstance() check is performed, or callables, which will</span>
<span class="sd">    validate and optionally convert the value.</span>

<span class="sd">    We can equate schemas also.</span>

<span class="sd">    For Example:</span>

<span class="sd">            &gt;&gt;&gt; v = Schema({Required(&#39;a&#39;): unicode})</span>
<span class="sd">            &gt;&gt;&gt; v1 = Schema({Required(&#39;a&#39;): unicode})</span>
<span class="sd">            &gt;&gt;&gt; v2 = Schema({Required(&#39;b&#39;): unicode})</span>
<span class="sd">            &gt;&gt;&gt; assert v == v1</span>
<span class="sd">            &gt;&gt;&gt; assert v != v2</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_extra_to_name</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">REMOVE_EXTRA</span><span class="p">:</span> <span class="s1">&#39;REMOVE_EXTRA&#39;</span><span class="p">,</span>
        <span class="n">ALLOW_EXTRA</span><span class="p">:</span> <span class="s1">&#39;ALLOW_EXTRA&#39;</span><span class="p">,</span>
        <span class="n">PREVENT_EXTRA</span><span class="p">:</span> <span class="s1">&#39;PREVENT_EXTRA&#39;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">schema</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="n">PREVENT_EXTRA</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a new Schema.</span>

<span class="sd">        :param schema: Validation schema. See :module:`voluptuous` for details.</span>
<span class="sd">        :param required: Keys defined in the schema must be in the data.</span>
<span class="sd">        :param extra: Specify how extra keys in the data are treated:</span>
<span class="sd">            - :const:`~voluptuous.PREVENT_EXTRA`: to disallow any undefined</span>
<span class="sd">              extra keys (raise ``Invalid``).</span>
<span class="sd">            - :const:`~voluptuous.ALLOW_EXTRA`: to include undefined extra</span>
<span class="sd">              keys in the output.</span>
<span class="sd">            - :const:`~voluptuous.REMOVE_EXTRA`: to exclude undefined extra keys</span>
<span class="sd">              from the output.</span>
<span class="sd">            - Any value other than the above defaults to</span>
<span class="sd">              :const:`~voluptuous.PREVENT_EXTRA`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">schema</span> <span class="o">=</span> <span class="n">schema</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">required</span> <span class="o">=</span> <span class="n">required</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extra</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">extra</span><span class="p">)</span>  <span class="c1"># ensure the value is an integer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compiled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compile</span><span class="p">(</span><span class="n">schema</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="Schema.infer"><a class="viewcode-back" href="../../voluptuous.html#voluptuous.schema_builder.Schema.infer">[docs]</a>    <span class="k">def</span> <span class="nf">infer</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a Schema from concrete data (e.g. an API response).</span>

<span class="sd">        For example, this will take a dict like:</span>

<span class="sd">        {</span>
<span class="sd">            &#39;foo&#39;: 1,</span>
<span class="sd">            &#39;bar&#39;: {</span>
<span class="sd">                &#39;a&#39;: True,</span>
<span class="sd">                &#39;b&#39;: False</span>
<span class="sd">            },</span>
<span class="sd">            &#39;baz&#39;: [&#39;purple&#39;, &#39;monkey&#39;, &#39;dishwasher&#39;]</span>
<span class="sd">        }</span>

<span class="sd">        And return a Schema:</span>

<span class="sd">        {</span>
<span class="sd">            &#39;foo&#39;: int,</span>
<span class="sd">            &#39;bar&#39;: {</span>
<span class="sd">                &#39;a&#39;: bool,</span>
<span class="sd">                &#39;b&#39;: bool</span>
<span class="sd">            },</span>
<span class="sd">            &#39;baz&#39;: [str]</span>
<span class="sd">        }</span>

<span class="sd">        Note: only very basic inference is supported.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">value_to_schema_type</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">return</span> <span class="nb">dict</span>
                <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">value_to_schema_type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">value</span><span class="p">)}</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">return</span> <span class="nb">list</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">[</span><span class="n">value_to_schema_type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value</span><span class="p">]</span>
            <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">cls</span><span class="p">(</span><span class="n">value_to_schema_type</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Schema</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="n">other</span><span class="o">.</span><span class="n">schema</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema</span>

    <span class="k">def</span> <span class="nf">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span> <span class="o">==</span> <span class="n">other</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;&lt;Schema(</span><span class="si">%s</span><span class="s2">, extra=</span><span class="si">%s</span><span class="s2">, required=</span><span class="si">%s</span><span class="s2">) object at 0x</span><span class="si">%x</span><span class="s2">&gt;&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extra_to_name</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">extra</span><span class="p">,</span> <span class="s1">&#39;??&#39;</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">required</span><span class="p">,</span> <span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Validate data against this schema.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compiled</span><span class="p">([],</span> <span class="n">data</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">er</span><span class="o">.</span><span class="n">MultipleInvalid</span><span class="p">:</span>
            <span class="k">raise</span>
        <span class="k">except</span> <span class="n">er</span><span class="o">.</span><span class="n">Invalid</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">er</span><span class="o">.</span><span class="n">MultipleInvalid</span><span class="p">([</span><span class="n">e</span><span class="p">])</span>
            <span class="c1"># return self.validate([], self.schema, data)</span>

    <span class="k">def</span> <span class="nf">_compile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">schema</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">schema</span> <span class="ow">is</span> <span class="n">Extra</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">lambda</span> <span class="n">_</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="n">v</span>
        <span class="k">if</span> <span class="n">schema</span> <span class="ow">is</span> <span class="n">Self</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compiled</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">schema</span><span class="p">,</span> <span class="s2">&quot;__voluptuous_compile__&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">schema</span><span class="o">.</span><span class="n">__voluptuous_compile__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">schema</span><span class="p">,</span> <span class="n">Object</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compile_object</span><span class="p">(</span><span class="n">schema</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">schema</span><span class="p">,</span> <span class="n">collections</span><span class="o">.</span><span class="n">Mapping</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compile_dict</span><span class="p">(</span><span class="n">schema</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">schema</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compile_list</span><span class="p">(</span><span class="n">schema</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">schema</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compile_tuple</span><span class="p">(</span><span class="n">schema</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">schema</span><span class="p">,</span> <span class="p">(</span><span class="nb">frozenset</span><span class="p">,</span> <span class="nb">set</span><span class="p">)):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compile_set</span><span class="p">(</span><span class="n">schema</span><span class="p">)</span>
        <span class="n">type_</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">schema</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">(</span><span class="n">schema</span><span class="p">):</span>
            <span class="n">type_</span> <span class="o">=</span> <span class="n">schema</span>
        <span class="k">if</span> <span class="n">type_</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">long</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">,</span> <span class="nb">object</span><span class="p">,</span>
                     <span class="nb">list</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="bp">None</span><span class="p">))</span> <span class="ow">or</span> <span class="nb">callable</span><span class="p">(</span><span class="n">schema</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">_compile_scalar</span><span class="p">(</span><span class="n">schema</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">er</span><span class="o">.</span><span class="n">SchemaError</span><span class="p">(</span><span class="s1">&#39;unsupported schema data type </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span>
                             <span class="nb">type</span><span class="p">(</span><span class="n">schema</span><span class="p">)</span><span class="o">.</span><span class="n">__name__</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compile_mapping</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">schema</span><span class="p">,</span> <span class="n">invalid_msg</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create validator for given mapping.&quot;&quot;&quot;</span>
        <span class="n">invalid_msg</span> <span class="o">=</span> <span class="n">invalid_msg</span> <span class="ow">or</span> <span class="s1">&#39;mapping value&#39;</span>

        <span class="c1"># Keys that may be required</span>
        <span class="n">all_required_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">schema</span>
                                <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">Extra</span> <span class="ow">and</span>
                                <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">required</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">(</span><span class="n">Optional</span><span class="p">,</span> <span class="n">Remove</span><span class="p">)))</span> <span class="ow">or</span>
                                 <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">Required</span><span class="p">)))</span>

        <span class="c1"># Keys that may have defaults</span>
        <span class="n">all_default_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">schema</span>
                               <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">Required</span><span class="p">)</span> <span class="ow">or</span>
                               <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">Optional</span><span class="p">))</span>

        <span class="n">_compiled_schema</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">skey</span><span class="p">,</span> <span class="n">svalue</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">schema</span><span class="p">):</span>
            <span class="n">new_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compile</span><span class="p">(</span><span class="n">skey</span><span class="p">)</span>
            <span class="n">new_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compile</span><span class="p">(</span><span class="n">svalue</span><span class="p">)</span>
            <span class="n">_compiled_schema</span><span class="p">[</span><span class="n">skey</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">new_key</span><span class="p">,</span> <span class="n">new_value</span><span class="p">)</span>

        <span class="n">candidates</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">_iterate_mapping_candidates</span><span class="p">(</span><span class="n">_compiled_schema</span><span class="p">))</span>

        <span class="c1"># After we have the list of candidates in the correct order, we want to apply some optimization so that each</span>
        <span class="c1"># key in the data being validated will be matched against the relevant schema keys only.</span>
        <span class="c1"># No point in matching against different keys</span>
        <span class="n">additional_candidates</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">candidates_by_key</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">skey</span><span class="p">,</span> <span class="p">(</span><span class="n">ckey</span><span class="p">,</span> <span class="n">cvalue</span><span class="p">)</span> <span class="ow">in</span> <span class="n">candidates</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">skey</span><span class="p">)</span> <span class="ow">in</span> <span class="n">primitive_types</span><span class="p">:</span>
                <span class="n">candidates_by_key</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">skey</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">skey</span><span class="p">,</span> <span class="p">(</span><span class="n">ckey</span><span class="p">,</span> <span class="n">cvalue</span><span class="p">)))</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">skey</span><span class="p">,</span> <span class="n">Marker</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">skey</span><span class="o">.</span><span class="n">schema</span><span class="p">)</span> <span class="ow">in</span> <span class="n">primitive_types</span><span class="p">:</span>
                <span class="n">candidates_by_key</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">skey</span><span class="o">.</span><span class="n">schema</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">skey</span><span class="p">,</span> <span class="p">(</span><span class="n">ckey</span><span class="p">,</span> <span class="n">cvalue</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># These are wildcards such as &#39;int&#39;, &#39;str&#39;, &#39;Remove&#39; and others which should be applied to all keys</span>
                <span class="n">additional_candidates</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">skey</span><span class="p">,</span> <span class="p">(</span><span class="n">ckey</span><span class="p">,</span> <span class="n">cvalue</span><span class="p">)))</span>

        <span class="k">def</span> <span class="nf">validate_mapping</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">iterable</span><span class="p">,</span> <span class="n">out</span><span class="p">):</span>
            <span class="n">required_keys</span> <span class="o">=</span> <span class="n">all_required_keys</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="c1"># Build a map of all provided key-value pairs.</span>
            <span class="c1"># The type(out) is used to retain ordering in case a ordered</span>
            <span class="c1"># map type is provided as input.</span>
            <span class="n">key_value_map</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">out</span><span class="p">)()</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">iterable</span><span class="p">:</span>
                <span class="n">key_value_map</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

            <span class="c1"># Insert default values for non-existing keys.</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">all_default_keys</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">default</span><span class="p">,</span> <span class="n">Undefined</span><span class="p">)</span> <span class="ow">and</span> \
                   <span class="n">key</span><span class="o">.</span><span class="n">schema</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">key_value_map</span><span class="p">:</span>
                    <span class="c1"># A default value has been specified for this missing</span>
                    <span class="c1"># key, insert it.</span>
                    <span class="n">key_value_map</span><span class="p">[</span><span class="n">key</span><span class="o">.</span><span class="n">schema</span><span class="p">]</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">default</span><span class="p">()</span>

            <span class="n">error</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">key_value_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">key_path</span> <span class="o">=</span> <span class="n">path</span> <span class="o">+</span> <span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="n">remove_key</span> <span class="o">=</span> <span class="bp">False</span>

                <span class="c1"># Optimization. Validate against the matching key first, then fallback to the rest</span>
                <span class="n">relevant_candidates</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="n">candidates_by_key</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">[]),</span> <span class="n">additional_candidates</span><span class="p">)</span>

                <span class="c1"># compare each given key/value against all compiled key/values</span>
                <span class="c1"># schema key, (compiled key, compiled value)</span>
                <span class="k">for</span> <span class="n">skey</span><span class="p">,</span> <span class="p">(</span><span class="n">ckey</span><span class="p">,</span> <span class="n">cvalue</span><span class="p">)</span> <span class="ow">in</span> <span class="n">relevant_candidates</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">new_key</span> <span class="o">=</span> <span class="n">ckey</span><span class="p">(</span><span class="n">key_path</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
                    <span class="k">except</span> <span class="n">er</span><span class="o">.</span><span class="n">Invalid</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">path</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">key_path</span><span class="p">):</span>
                            <span class="k">raise</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">error</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">path</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">error</span><span class="o">.</span><span class="n">path</span><span class="p">):</span>
                            <span class="n">error</span> <span class="o">=</span> <span class="n">e</span>
                        <span class="k">continue</span>
                    <span class="c1"># Backtracking is not performed once a key is selected, so if</span>
                    <span class="c1"># the value is invalid we immediately throw an exception.</span>
                    <span class="n">exception_errors</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="c1"># check if the key is marked for removal</span>
                    <span class="n">is_remove</span> <span class="o">=</span> <span class="n">new_key</span> <span class="ow">is</span> <span class="n">Remove</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">cval</span> <span class="o">=</span> <span class="n">cvalue</span><span class="p">(</span><span class="n">key_path</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                        <span class="c1"># include if it&#39;s not marked for removal</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_remove</span><span class="p">:</span>
                            <span class="n">out</span><span class="p">[</span><span class="n">new_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">cval</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">remove_key</span> <span class="o">=</span> <span class="bp">True</span>
                            <span class="k">continue</span>
                    <span class="k">except</span> <span class="n">er</span><span class="o">.</span><span class="n">MultipleInvalid</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">exception_errors</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">errors</span><span class="p">)</span>
                    <span class="k">except</span> <span class="n">er</span><span class="o">.</span><span class="n">Invalid</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">exception_errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">exception_errors</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">is_remove</span> <span class="ow">or</span> <span class="n">remove_key</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="k">for</span> <span class="n">err</span> <span class="ow">in</span> <span class="n">exception_errors</span><span class="p">:</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">err</span><span class="o">.</span><span class="n">path</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">key_path</span><span class="p">):</span>
                                <span class="n">err</span><span class="o">.</span><span class="n">error_type</span> <span class="o">=</span> <span class="n">invalid_msg</span>
                            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
                        <span class="c1"># If there is a validation error for a required</span>
                        <span class="c1"># key, this means that the key was provided.</span>
                        <span class="c1"># Discard the required key so it does not</span>
                        <span class="c1"># create an additional, noisy exception.</span>
                        <span class="n">required_keys</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="n">skey</span><span class="p">)</span>
                        <span class="k">break</span>

                    <span class="c1"># Key and value okay, mark as found in case it was</span>
                    <span class="c1"># a Required() field.</span>
                    <span class="n">required_keys</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="n">skey</span><span class="p">)</span>

                    <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">remove_key</span><span class="p">:</span>
                        <span class="c1"># remove key</span>
                        <span class="k">continue</span>
                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">extra</span> <span class="o">==</span> <span class="n">ALLOW_EXTRA</span><span class="p">:</span>
                        <span class="n">out</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">extra</span> <span class="o">!=</span> <span class="n">REMOVE_EXTRA</span><span class="p">:</span>
                        <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">er</span><span class="o">.</span><span class="n">Invalid</span><span class="p">(</span><span class="s1">&#39;extra keys not allowed&#39;</span><span class="p">,</span> <span class="n">key_path</span><span class="p">))</span>
                        <span class="c1"># else REMOVE_EXTRA: ignore the key so it&#39;s removed from output</span>

            <span class="c1"># for any required keys left that weren&#39;t found and don&#39;t have defaults:</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">required_keys</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">msg</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s1">&#39;msg&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">key</span><span class="o">.</span><span class="n">msg</span> <span class="k">else</span> <span class="s1">&#39;required key not provided&#39;</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">er</span><span class="o">.</span><span class="n">RequiredFieldInvalid</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">path</span> <span class="o">+</span> <span class="p">[</span><span class="n">key</span><span class="p">]))</span>
            <span class="k">if</span> <span class="n">errors</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">er</span><span class="o">.</span><span class="n">MultipleInvalid</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">out</span>

        <span class="k">return</span> <span class="n">validate_mapping</span>

    <span class="k">def</span> <span class="nf">_compile_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">schema</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Validate an object.</span>

<span class="sd">        Has the same behavior as dictionary validator but work with object</span>
<span class="sd">        attributes.</span>

<span class="sd">        For example:</span>

<span class="sd">            &gt;&gt;&gt; class Structure(object):</span>
<span class="sd">            ...     def __init__(self, one=None, three=None):</span>
<span class="sd">            ...         self.one = one</span>
<span class="sd">            ...         self.three = three</span>
<span class="sd">            ...</span>
<span class="sd">            &gt;&gt;&gt; validate = Schema(Object({&#39;one&#39;: &#39;two&#39;, &#39;three&#39;: &#39;four&#39;}, cls=Structure))</span>
<span class="sd">            &gt;&gt;&gt; with raises(er.MultipleInvalid, &quot;not a valid value for object value @ data[&#39;one&#39;]&quot;):</span>
<span class="sd">            ...   validate(Structure(one=&#39;three&#39;))</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">base_validate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compile_mapping</span><span class="p">(</span>
            <span class="n">schema</span><span class="p">,</span> <span class="n">invalid_msg</span><span class="o">=</span><span class="s1">&#39;object value&#39;</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">validate_object</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">schema</span><span class="o">.</span><span class="n">cls</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">UNDEFINED</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">schema</span><span class="o">.</span><span class="n">cls</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">er</span><span class="o">.</span><span class="n">ObjectInvalid</span><span class="p">(</span><span class="s1">&#39;expected a {0!r}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">schema</span><span class="o">.</span><span class="n">cls</span><span class="p">),</span> <span class="n">path</span><span class="p">)</span>
            <span class="n">iterable</span> <span class="o">=</span> <span class="n">_iterate_object</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">iterable</span> <span class="o">=</span> <span class="n">ifilter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">,</span> <span class="n">iterable</span><span class="p">)</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">base_validate</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">iterable</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="n">data</span><span class="p">)(</span><span class="o">**</span><span class="n">out</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">validate_object</span>

    <span class="k">def</span> <span class="nf">_compile_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">schema</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Validate a dictionary.</span>

<span class="sd">        A dictionary schema can contain a set of values, or at most one</span>
<span class="sd">        validator function/type.</span>

<span class="sd">        A dictionary schema will only validate a dictionary:</span>

<span class="sd">            &gt;&gt;&gt; validate = Schema({})</span>
<span class="sd">            &gt;&gt;&gt; with raises(er.MultipleInvalid, &#39;expected a dictionary&#39;):</span>
<span class="sd">            ...   validate([])</span>

<span class="sd">        An invalid dictionary value:</span>

<span class="sd">            &gt;&gt;&gt; validate = Schema({&#39;one&#39;: &#39;two&#39;, &#39;three&#39;: &#39;four&#39;})</span>
<span class="sd">            &gt;&gt;&gt; with raises(er.MultipleInvalid, &quot;not a valid value for dictionary value @ data[&#39;one&#39;]&quot;):</span>
<span class="sd">            ...   validate({&#39;one&#39;: &#39;three&#39;})</span>

<span class="sd">        An invalid key:</span>

<span class="sd">            &gt;&gt;&gt; with raises(er.MultipleInvalid, &quot;extra keys not allowed @ data[&#39;two&#39;]&quot;):</span>
<span class="sd">            ...   validate({&#39;two&#39;: &#39;three&#39;})</span>


<span class="sd">        Validation function, in this case the &quot;int&quot; type:</span>

<span class="sd">            &gt;&gt;&gt; validate = Schema({&#39;one&#39;: &#39;two&#39;, &#39;three&#39;: &#39;four&#39;, int: str})</span>

<span class="sd">        Valid integer input:</span>

<span class="sd">            &gt;&gt;&gt; validate({10: &#39;twenty&#39;})</span>
<span class="sd">            {10: &#39;twenty&#39;}</span>

<span class="sd">        By default, a &quot;type&quot; in the schema (in this case &quot;int&quot;) will be used</span>
<span class="sd">        purely to validate that the corresponding value is of that type. It</span>
<span class="sd">        will not Coerce the value:</span>

<span class="sd">            &gt;&gt;&gt; with raises(er.MultipleInvalid, &quot;extra keys not allowed @ data[&#39;10&#39;]&quot;):</span>
<span class="sd">            ...   validate({&#39;10&#39;: &#39;twenty&#39;})</span>

<span class="sd">        Wrap them in the Coerce() function to achieve this:</span>
<span class="sd">            &gt;&gt;&gt; from voluptuous import Coerce</span>
<span class="sd">            &gt;&gt;&gt; validate = Schema({&#39;one&#39;: &#39;two&#39;, &#39;three&#39;: &#39;four&#39;,</span>
<span class="sd">            ...                    Coerce(int): str})</span>
<span class="sd">            &gt;&gt;&gt; validate({&#39;10&#39;: &#39;twenty&#39;})</span>
<span class="sd">            {10: &#39;twenty&#39;}</span>

<span class="sd">        Custom message for required key</span>

<span class="sd">            &gt;&gt;&gt; validate = Schema({Required(&#39;one&#39;, &#39;required&#39;): &#39;two&#39;})</span>
<span class="sd">            &gt;&gt;&gt; with raises(er.MultipleInvalid, &quot;required @ data[&#39;one&#39;]&quot;):</span>
<span class="sd">            ...   validate({})</span>

<span class="sd">        (This is to avoid unexpected surprises.)</span>

<span class="sd">        Multiple errors for nested field in a dict:</span>

<span class="sd">        &gt;&gt;&gt; validate = Schema({</span>
<span class="sd">        ...     &#39;adict&#39;: {</span>
<span class="sd">        ...         &#39;strfield&#39;: str,</span>
<span class="sd">        ...         &#39;intfield&#39;: int</span>
<span class="sd">        ...     }</span>
<span class="sd">        ... })</span>
<span class="sd">        &gt;&gt;&gt; try:</span>
<span class="sd">        ...     validate({</span>
<span class="sd">        ...         &#39;adict&#39;: {</span>
<span class="sd">        ...             &#39;strfield&#39;: 123,</span>
<span class="sd">        ...             &#39;intfield&#39;: &#39;one&#39;</span>
<span class="sd">        ...         }</span>
<span class="sd">        ...     })</span>
<span class="sd">        ... except er.MultipleInvalid as e:</span>
<span class="sd">        ...     print(sorted(str(i) for i in e.errors)) # doctest: +NORMALIZE_WHITESPACE</span>
<span class="sd">        [&quot;expected int for dictionary value @ data[&#39;adict&#39;][&#39;intfield&#39;]&quot;,</span>
<span class="sd">         &quot;expected str for dictionary value @ data[&#39;adict&#39;][&#39;strfield&#39;]&quot;]</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">base_validate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compile_mapping</span><span class="p">(</span>
            <span class="n">schema</span><span class="p">,</span> <span class="n">invalid_msg</span><span class="o">=</span><span class="s1">&#39;dictionary value&#39;</span><span class="p">)</span>

        <span class="n">groups_of_exclusion</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">groups_of_inclusion</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">schema</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">Exclusive</span><span class="p">):</span>
                <span class="n">g</span> <span class="o">=</span> <span class="n">groups_of_exclusion</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">group_of_exclusion</span><span class="p">,</span> <span class="p">[])</span>
                <span class="n">g</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">Inclusive</span><span class="p">):</span>
                <span class="n">g</span> <span class="o">=</span> <span class="n">groups_of_inclusion</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">group_of_inclusion</span><span class="p">,</span> <span class="p">[])</span>
                <span class="n">g</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">validate_dict</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">er</span><span class="o">.</span><span class="n">DictInvalid</span><span class="p">(</span><span class="s1">&#39;expected a dictionary&#39;</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>

            <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groups_of_exclusion</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">exists</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="k">for</span> <span class="n">exclusive</span> <span class="ow">in</span> <span class="n">group</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">exclusive</span><span class="o">.</span><span class="n">schema</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">exists</span><span class="p">:</span>
                            <span class="n">msg</span> <span class="o">=</span> <span class="n">exclusive</span><span class="o">.</span><span class="n">msg</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">exclusive</span><span class="p">,</span> <span class="s1">&#39;msg&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">exclusive</span><span class="o">.</span><span class="n">msg</span> <span class="k">else</span> \
                                <span class="s2">&quot;two or more values in the same group of exclusion &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">label</span>
                            <span class="n">next_path</span> <span class="o">=</span> <span class="n">path</span> <span class="o">+</span> <span class="p">[</span><span class="n">VirtualPathComponent</span><span class="p">(</span><span class="n">label</span><span class="p">)]</span>
                            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">er</span><span class="o">.</span><span class="n">ExclusiveInvalid</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">next_path</span><span class="p">))</span>
                            <span class="k">break</span>
                        <span class="n">exists</span> <span class="o">=</span> <span class="bp">True</span>

            <span class="k">if</span> <span class="n">errors</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">er</span><span class="o">.</span><span class="n">MultipleInvalid</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groups_of_inclusion</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">included</span> <span class="o">=</span> <span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">schema</span> <span class="ow">in</span> <span class="n">data</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">group</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">included</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">included</span><span class="p">):</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;some but not all values in the same group of inclusion &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">label</span>
                    <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">group</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="s1">&#39;msg&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">g</span><span class="o">.</span><span class="n">msg</span><span class="p">:</span>
                            <span class="n">msg</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">msg</span>
                            <span class="k">break</span>
                    <span class="n">next_path</span> <span class="o">=</span> <span class="n">path</span> <span class="o">+</span> <span class="p">[</span><span class="n">VirtualPathComponent</span><span class="p">(</span><span class="n">label</span><span class="p">)]</span>
                    <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">er</span><span class="o">.</span><span class="n">InclusiveInvalid</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">next_path</span><span class="p">))</span>
                    <span class="k">break</span>

            <span class="k">if</span> <span class="n">errors</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">er</span><span class="o">.</span><span class="n">MultipleInvalid</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span>

            <span class="n">out</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">__class__</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">base_validate</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">out</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">validate_dict</span>

    <span class="k">def</span> <span class="nf">_compile_sequence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">schema</span><span class="p">,</span> <span class="n">seq_type</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Validate a sequence type.</span>

<span class="sd">        This is a sequence of valid values or validators tried in order.</span>

<span class="sd">        &gt;&gt;&gt; validator = Schema([&#39;one&#39;, &#39;two&#39;, int])</span>
<span class="sd">        &gt;&gt;&gt; validator([&#39;one&#39;])</span>
<span class="sd">        [&#39;one&#39;]</span>
<span class="sd">        &gt;&gt;&gt; with raises(er.MultipleInvalid, &#39;expected int @ data[0]&#39;):</span>
<span class="sd">        ...   validator([3.5])</span>
<span class="sd">        &gt;&gt;&gt; validator([1])</span>
<span class="sd">        [1]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_compiled</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_compile</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">schema</span><span class="p">]</span>
        <span class="n">seq_type_name</span> <span class="o">=</span> <span class="n">seq_type</span><span class="o">.</span><span class="n">__name__</span>

        <span class="k">def</span> <span class="nf">validate_sequence</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">seq_type</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">er</span><span class="o">.</span><span class="n">SequenceTypeInvalid</span><span class="p">(</span><span class="s1">&#39;expected a </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">seq_type_name</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>

            <span class="c1"># Empty seq schema, allow any data.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">schema</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">er</span><span class="o">.</span><span class="n">MultipleInvalid</span><span class="p">([</span>
                        <span class="n">er</span><span class="o">.</span><span class="n">ValueInvalid</span><span class="p">(</span><span class="s1">&#39;not a valid value&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">value</span><span class="p">])</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">data</span>
                    <span class="p">])</span>
                <span class="k">return</span> <span class="n">data</span>

            <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">invalid</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">index_path</span> <span class="o">=</span> <span class="n">UNDEFINED</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
                <span class="n">index_path</span> <span class="o">=</span> <span class="n">path</span> <span class="o">+</span> <span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">invalid</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="k">for</span> <span class="n">validate</span> <span class="ow">in</span> <span class="n">_compiled</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">cval</span> <span class="o">=</span> <span class="n">validate</span><span class="p">(</span><span class="n">index_path</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">cval</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">Remove</span><span class="p">:</span>  <span class="c1"># do not include Remove values</span>
                            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cval</span><span class="p">)</span>
                        <span class="k">break</span>
                    <span class="k">except</span> <span class="n">er</span><span class="o">.</span><span class="n">Invalid</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">path</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">index_path</span><span class="p">):</span>
                            <span class="k">raise</span>
                        <span class="n">invalid</span> <span class="o">=</span> <span class="n">e</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">invalid</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">errors</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">er</span><span class="o">.</span><span class="n">MultipleInvalid</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">_isnamedtuple</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
                <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="n">data</span><span class="p">)(</span><span class="o">*</span><span class="n">out</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="n">data</span><span class="p">)(</span><span class="n">out</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">validate_sequence</span>

    <span class="k">def</span> <span class="nf">_compile_tuple</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">schema</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Validate a tuple.</span>

<span class="sd">        A tuple is a sequence of valid values or validators tried in order.</span>

<span class="sd">        &gt;&gt;&gt; validator = Schema((&#39;one&#39;, &#39;two&#39;, int))</span>
<span class="sd">        &gt;&gt;&gt; validator((&#39;one&#39;,))</span>
<span class="sd">        (&#39;one&#39;,)</span>
<span class="sd">        &gt;&gt;&gt; with raises(er.MultipleInvalid, &#39;expected int @ data[0]&#39;):</span>
<span class="sd">        ...   validator((3.5,))</span>
<span class="sd">        &gt;&gt;&gt; validator((1,))</span>
<span class="sd">        (1,)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compile_sequence</span><span class="p">(</span><span class="n">schema</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compile_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">schema</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Validate a list.</span>

<span class="sd">        A list is a sequence of valid values or validators tried in order.</span>

<span class="sd">        &gt;&gt;&gt; validator = Schema([&#39;one&#39;, &#39;two&#39;, int])</span>
<span class="sd">        &gt;&gt;&gt; validator([&#39;one&#39;])</span>
<span class="sd">        [&#39;one&#39;]</span>
<span class="sd">        &gt;&gt;&gt; with raises(er.MultipleInvalid, &#39;expected int @ data[0]&#39;):</span>
<span class="sd">        ...   validator([3.5])</span>
<span class="sd">        &gt;&gt;&gt; validator([1])</span>
<span class="sd">        [1]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compile_sequence</span><span class="p">(</span><span class="n">schema</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compile_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">schema</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Validate a set.</span>

<span class="sd">        A set is an unordered collection of unique elements.</span>

<span class="sd">        &gt;&gt;&gt; validator = Schema({int})</span>
<span class="sd">        &gt;&gt;&gt; validator(set([42])) == set([42])</span>
<span class="sd">        True</span>
<span class="sd">        &gt;&gt;&gt; with raises(er.Invalid, &#39;expected a set&#39;):</span>
<span class="sd">        ...   validator(42)</span>
<span class="sd">        &gt;&gt;&gt; with raises(er.MultipleInvalid, &#39;invalid value in set&#39;):</span>
<span class="sd">        ...   validator(set([&#39;a&#39;]))</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">type_</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">schema</span><span class="p">)</span>
        <span class="n">type_name</span> <span class="o">=</span> <span class="n">type_</span><span class="o">.</span><span class="n">__name__</span>

        <span class="k">def</span> <span class="nf">validate_set</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">type_</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">er</span><span class="o">.</span><span class="n">Invalid</span><span class="p">(</span><span class="s1">&#39;expected a </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">type_name</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>

            <span class="n">_compiled</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_compile</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">schema</span><span class="p">]</span>
            <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">validate</span> <span class="ow">in</span> <span class="n">_compiled</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">validate</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                        <span class="k">break</span>
                    <span class="k">except</span> <span class="n">er</span><span class="o">.</span><span class="n">Invalid</span><span class="p">:</span>
                        <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">invalid</span> <span class="o">=</span> <span class="n">er</span><span class="o">.</span><span class="n">Invalid</span><span class="p">(</span><span class="s1">&#39;invalid value in </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">type_name</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
                    <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">invalid</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">errors</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">er</span><span class="o">.</span><span class="n">MultipleInvalid</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">data</span>

        <span class="k">return</span> <span class="n">validate_set</span>

<div class="viewcode-block" id="Schema.extend"><a class="viewcode-back" href="../../voluptuous.html#voluptuous.schema_builder.Schema.extend">[docs]</a>    <span class="k">def</span> <span class="nf">extend</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">schema</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a new `Schema` by merging this and the provided `schema`.</span>

<span class="sd">        Neither this `Schema` nor the provided `schema` are modified. The</span>
<span class="sd">        resulting `Schema` inherits the `required` and `extra` parameters of</span>
<span class="sd">        this, unless overridden.</span>

<span class="sd">        Both schemas must be dictionary-based.</span>

<span class="sd">        :param schema: dictionary to extend this `Schema` with</span>
<span class="sd">        :param required: if set, overrides `required` of this `Schema`</span>
<span class="sd">        :param extra: if set, overrides `extra` of this `Schema`</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="p">)</span> <span class="o">==</span> <span class="nb">dict</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">schema</span><span class="p">)</span> <span class="o">==</span> <span class="nb">dict</span><span class="p">,</span> <span class="s1">&#39;Both schemas must be dictionary-based&#39;</span>

        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># returns the key that may have been passed as arugment to Marker constructor</span>
        <span class="k">def</span> <span class="nf">key_literal</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">schema</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">Marker</span><span class="p">)</span> <span class="k">else</span> <span class="n">key</span><span class="p">)</span>

        <span class="c1"># build a map that takes the key literals to the needed objects</span>
        <span class="c1"># literal -&gt; Required|Optional|literal</span>
        <span class="n">result_key_map</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">key_literal</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="n">key</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">result</span><span class="p">)</span>

        <span class="c1"># for each item in the extension schema, replace duplicates</span>
        <span class="c1"># or add new keys</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">schema</span><span class="p">):</span>

            <span class="c1"># if the key is already in the dictionary, we need to replace it</span>
            <span class="c1"># transform key to literal before checking presence</span>
            <span class="k">if</span> <span class="n">key_literal</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="ow">in</span> <span class="n">result_key_map</span><span class="p">:</span>

                <span class="n">result_key</span> <span class="o">=</span> <span class="n">result_key_map</span><span class="p">[</span><span class="n">key_literal</span><span class="p">(</span><span class="n">key</span><span class="p">)]</span>
                <span class="n">result_value</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="n">result_key</span><span class="p">]</span>

                <span class="c1"># if both are dictionaries, we need to extend recursively</span>
                <span class="c1"># create the new extended sub schema, then remove the old key and add the new one</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">result_value</span><span class="p">)</span> <span class="o">==</span> <span class="nb">dict</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="nb">dict</span><span class="p">:</span>
                    <span class="n">new_value</span> <span class="o">=</span> <span class="n">Schema</span><span class="p">(</span><span class="n">result_value</span><span class="p">)</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">schema</span>
                    <span class="k">del</span> <span class="n">result</span><span class="p">[</span><span class="n">result_key</span><span class="p">]</span>
                    <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_value</span>
                <span class="c1"># one or the other or both are not sub-schemas, simple replacement is fine</span>
                <span class="c1"># remove old key and add new one</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">result</span><span class="p">[</span><span class="n">result_key</span><span class="p">]</span>
                    <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

            <span class="c1"># key is new and can simply be added</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="c1"># recompile and send old object</span>
        <span class="n">result_required</span> <span class="o">=</span> <span class="p">(</span><span class="n">required</span> <span class="k">if</span> <span class="n">required</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">required</span><span class="p">)</span>
        <span class="n">result_extra</span> <span class="o">=</span> <span class="p">(</span><span class="n">extra</span> <span class="k">if</span> <span class="n">extra</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">extra</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Schema</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="n">result_required</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="n">result_extra</span><span class="p">)</span></div></div>


<span class="k">def</span> <span class="nf">_compile_scalar</span><span class="p">(</span><span class="n">schema</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A scalar value.</span>

<span class="sd">    The schema can either be a value or a type.</span>

<span class="sd">    &gt;&gt;&gt; _compile_scalar(int)([], 1)</span>
<span class="sd">    1</span>
<span class="sd">    &gt;&gt;&gt; with raises(er.Invalid, &#39;expected float&#39;):</span>
<span class="sd">    ...   _compile_scalar(float)([], &#39;1&#39;)</span>

<span class="sd">    Callables have</span>
<span class="sd">    &gt;&gt;&gt; _compile_scalar(lambda v: float(v))([], &#39;1&#39;)</span>
<span class="sd">    1.0</span>

<span class="sd">    As a convenience, ValueError&#39;s are trapped:</span>

<span class="sd">    &gt;&gt;&gt; with raises(er.Invalid, &#39;not a valid value&#39;):</span>
<span class="sd">    ...   _compile_scalar(lambda v: float(v))([], &#39;a&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">(</span><span class="n">schema</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">validate_instance</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">schema</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">data</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;expected </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">schema</span><span class="o">.</span><span class="n">__name__</span>
                <span class="k">raise</span> <span class="n">er</span><span class="o">.</span><span class="n">TypeInvalid</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">validate_instance</span>

    <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">schema</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">validate_callable</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">schema</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">er</span><span class="o">.</span><span class="n">ValueInvalid</span><span class="p">(</span><span class="s1">&#39;not a valid value&#39;</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">er</span><span class="o">.</span><span class="n">Invalid</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">e</span><span class="o">.</span><span class="n">prepend</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                <span class="k">raise</span>

        <span class="k">return</span> <span class="n">validate_callable</span>

    <span class="k">def</span> <span class="nf">validate_value</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">data</span> <span class="o">!=</span> <span class="n">schema</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">er</span><span class="o">.</span><span class="n">ScalarInvalid</span><span class="p">(</span><span class="s1">&#39;not a valid value&#39;</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span>

    <span class="k">return</span> <span class="n">validate_value</span>


<span class="k">def</span> <span class="nf">_compile_itemsort</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;return sort function of mappings&#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">is_extra</span><span class="p">(</span><span class="n">key_</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">key_</span> <span class="ow">is</span> <span class="n">Extra</span>

    <span class="k">def</span> <span class="nf">is_remove</span><span class="p">(</span><span class="n">key_</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key_</span><span class="p">,</span> <span class="n">Remove</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">is_marker</span><span class="p">(</span><span class="n">key_</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key_</span><span class="p">,</span> <span class="n">Marker</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">is_type</span><span class="p">(</span><span class="n">key_</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">(</span><span class="n">key_</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">is_callable</span><span class="p">(</span><span class="n">key_</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">callable</span><span class="p">(</span><span class="n">key_</span><span class="p">)</span>

    <span class="c1"># priority list for map sorting (in order of checking)</span>
    <span class="c1"># We want Extra to match last, because it&#39;s a catch-all. On the other hand,</span>
    <span class="c1"># Remove markers should match first (since invalid values will not</span>
    <span class="c1"># raise an Error, instead the validator will check if other schemas match</span>
    <span class="c1"># the same value).</span>
    <span class="n">priority</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">1</span><span class="p">,</span> <span class="n">is_remove</span><span class="p">),</span>  <span class="c1"># Remove highest priority after values</span>
                <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">is_marker</span><span class="p">),</span>  <span class="c1"># then other Markers</span>
                <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">is_type</span><span class="p">),</span>  <span class="c1"># types/classes lowest before Extra</span>
                <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">is_callable</span><span class="p">),</span>  <span class="c1"># callables after markers</span>
                <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">is_extra</span><span class="p">)]</span>  <span class="c1"># Extra lowest priority</span>

    <span class="k">def</span> <span class="nf">item_priority</span><span class="p">(</span><span class="n">item_</span><span class="p">):</span>
        <span class="n">key_</span> <span class="o">=</span> <span class="n">item_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">check_</span> <span class="ow">in</span> <span class="n">priority</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">check_</span><span class="p">(</span><span class="n">key_</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">i</span>
        <span class="c1"># values have hightest priorities</span>
        <span class="k">return</span> <span class="mi">0</span>

    <span class="k">return</span> <span class="n">item_priority</span>


<span class="n">_sort_item</span> <span class="o">=</span> <span class="n">_compile_itemsort</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">_iterate_mapping_candidates</span><span class="p">(</span><span class="n">schema</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Iterate over schema in a meaningful order.&quot;&quot;&quot;</span>
    <span class="c1"># Without this, Extra might appear first in the iterator, and fail to</span>
    <span class="c1"># validate a key even though it&#39;s a Required that has its own validation,</span>
    <span class="c1"># generating a false positive.</span>
    <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">iteritems</span><span class="p">(</span><span class="n">schema</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="n">_sort_item</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_iterate_object</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return iterator over object attributes. Respect objects with</span>
<span class="sd">    defined __slots__.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">d</span> <span class="o">=</span> <span class="nb">vars</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
        <span class="c1"># maybe we have named tuple here?</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;_asdict&#39;</span><span class="p">):</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_asdict</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
        <span class="k">yield</span> <span class="n">item</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">slots</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">__slots__</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">slots</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">!=</span> <span class="s1">&#39;__dict__&#39;</span><span class="p">:</span>
                <span class="k">yield</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">key</span><span class="p">))</span>


<div class="viewcode-block" id="Msg"><a class="viewcode-back" href="../../voluptuous.html#voluptuous.schema_builder.Msg">[docs]</a><span class="k">class</span> <span class="nc">Msg</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Report a user-friendly message if a schema fails to validate.</span>

<span class="sd">    &gt;&gt;&gt; validate = Schema(</span>
<span class="sd">    ...   Msg([&#39;one&#39;, &#39;two&#39;, int],</span>
<span class="sd">    ...       &#39;should be one of &quot;one&quot;, &quot;two&quot; or an integer&#39;))</span>
<span class="sd">    &gt;&gt;&gt; with raises(er.MultipleInvalid, &#39;should be one of &quot;one&quot;, &quot;two&quot; or an integer&#39;):</span>
<span class="sd">    ...   validate([&#39;three&#39;])</span>

<span class="sd">    Messages are only applied to invalid direct descendants of the schema:</span>

<span class="sd">    &gt;&gt;&gt; validate = Schema(Msg([[&#39;one&#39;, &#39;two&#39;, int]], &#39;not okay!&#39;))</span>
<span class="sd">    &gt;&gt;&gt; with raises(er.MultipleInvalid, &#39;expected int @ data[0][0]&#39;):</span>
<span class="sd">    ...   validate([[&#39;three&#39;]])</span>

<span class="sd">    The type which is thrown can be overridden but needs to be a subclass of Invalid</span>

<span class="sd">    &gt;&gt;&gt; with raises(er.SchemaError, &#39;Msg can only use subclases of Invalid as custom class&#39;):</span>
<span class="sd">    ...   validate = Schema(Msg([int], &#39;should be int&#39;, cls=KeyError))</span>

<span class="sd">    If you do use a subclass of Invalid, that error will be thrown (wrapped in a MultipleInvalid)</span>

<span class="sd">    &gt;&gt;&gt; validate = Schema(Msg([[&#39;one&#39;, &#39;two&#39;, int]], &#39;not okay!&#39;, cls=er.RangeInvalid))</span>
<span class="sd">    &gt;&gt;&gt; try:</span>
<span class="sd">    ...  validate([&#39;three&#39;])</span>
<span class="sd">    ... except er.MultipleInvalid as e:</span>
<span class="sd">    ...   assert isinstance(e.errors[0], er.RangeInvalid)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">schema</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">cls</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">cls</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">er</span><span class="o">.</span><span class="n">Invalid</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">er</span><span class="o">.</span><span class="n">SchemaError</span><span class="p">(</span><span class="s2">&quot;Msg can only use subclases of&quot;</span>
                                 <span class="s2">&quot; Invalid as custom class&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_schema</span> <span class="o">=</span> <span class="n">schema</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">schema</span> <span class="o">=</span> <span class="n">Schema</span><span class="p">(</span><span class="n">schema</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msg</span> <span class="o">=</span> <span class="n">msg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cls</span> <span class="o">=</span> <span class="n">cls</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">er</span><span class="o">.</span><span class="n">Invalid</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">path</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">e</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cls</span> <span class="ow">or</span> <span class="n">er</span><span class="o">.</span><span class="n">Invalid</span><span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;Msg(</span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">, cls=</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_schema</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="p">)</span></div>


<div class="viewcode-block" id="Object"><a class="viewcode-back" href="../../voluptuous.html#voluptuous.schema_builder.Object">[docs]</a><span class="k">class</span> <span class="nc">Object</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Indicate that we should work with attributes, not keys.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">schema</span><span class="p">,</span> <span class="n">cls</span><span class="o">=</span><span class="n">UNDEFINED</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cls</span> <span class="o">=</span> <span class="n">cls</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Object</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">schema</span><span class="p">)</span></div>


<div class="viewcode-block" id="VirtualPathComponent"><a class="viewcode-back" href="../../voluptuous.html#voluptuous.schema_builder.VirtualPathComponent">[docs]</a><span class="k">class</span> <span class="nc">VirtualPathComponent</span><span class="p">(</span><span class="nb">str</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;&lt;&#39;</span> <span class="o">+</span> <span class="bp">self</span> <span class="o">+</span> <span class="s1">&#39;&gt;&#39;</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__str__</span><span class="p">()</span></div>


<span class="c1"># Markers.py</span>


<div class="viewcode-block" id="Marker"><a class="viewcode-back" href="../../voluptuous.html#voluptuous.schema_builder.Marker">[docs]</a><span class="k">class</span> <span class="nc">Marker</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Mark nodes for special treatment.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">schema_</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">schema</span> <span class="o">=</span> <span class="n">schema_</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_schema</span> <span class="o">=</span> <span class="n">Schema</span><span class="p">(</span><span class="n">schema_</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msg</span> <span class="o">=</span> <span class="n">msg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">description</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_schema</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">er</span><span class="o">.</span><span class="n">Invalid</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">msg</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">path</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span>
            <span class="k">raise</span> <span class="n">er</span><span class="o">.</span><span class="n">Invalid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__lt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Marker</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema</span> <span class="o">&lt;</span> <span class="n">other</span><span class="o">.</span><span class="n">schema</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema</span> <span class="o">&lt;</span> <span class="n">other</span>

    <span class="k">def</span> <span class="nf">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema</span> <span class="o">==</span> <span class="n">other</span>

    <span class="k">def</span> <span class="nf">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="ow">not</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">schema</span> <span class="o">==</span> <span class="n">other</span><span class="p">)</span></div>


<div class="viewcode-block" id="Optional"><a class="viewcode-back" href="../../voluptuous.html#voluptuous.schema_builder.Optional">[docs]</a><span class="k">class</span> <span class="nc">Optional</span><span class="p">(</span><span class="n">Marker</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Mark a node in the schema as optional, and optionally provide a default</span>

<span class="sd">    &gt;&gt;&gt; schema = Schema({Optional(&#39;key&#39;): str})</span>
<span class="sd">    &gt;&gt;&gt; schema({})</span>
<span class="sd">    {}</span>
<span class="sd">    &gt;&gt;&gt; schema = Schema({Optional(&#39;key&#39;, default=&#39;value&#39;): str})</span>
<span class="sd">    &gt;&gt;&gt; schema({})</span>
<span class="sd">    {&#39;key&#39;: &#39;value&#39;}</span>
<span class="sd">    &gt;&gt;&gt; schema = Schema({Optional(&#39;key&#39;, default=list): list})</span>
<span class="sd">    &gt;&gt;&gt; schema({})</span>
<span class="sd">    {&#39;key&#39;: []}</span>

<span class="sd">    If &#39;required&#39; flag is set for an entire schema, optional keys aren&#39;t required</span>

<span class="sd">    &gt;&gt;&gt; schema = Schema({</span>
<span class="sd">    ...    Optional(&#39;key&#39;): str,</span>
<span class="sd">    ...    &#39;key2&#39;: str</span>
<span class="sd">    ... }, required=True)</span>
<span class="sd">    &gt;&gt;&gt; schema({&#39;key2&#39;:&#39;value&#39;})</span>
<span class="sd">    {&#39;key2&#39;: &#39;value&#39;}</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">schema</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">UNDEFINED</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Optional</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">schema</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="n">msg</span><span class="p">,</span>
                                       <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default</span> <span class="o">=</span> <span class="n">default_factory</span><span class="p">(</span><span class="n">default</span><span class="p">)</span></div>


<div class="viewcode-block" id="Exclusive"><a class="viewcode-back" href="../../voluptuous.html#voluptuous.schema_builder.Exclusive">[docs]</a><span class="k">class</span> <span class="nc">Exclusive</span><span class="p">(</span><span class="n">Optional</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Mark a node in the schema as exclusive.</span>

<span class="sd">    Exclusive keys inherited from Optional:</span>

<span class="sd">    &gt;&gt;&gt; schema = Schema({Exclusive(&#39;alpha&#39;, &#39;angles&#39;): int, Exclusive(&#39;beta&#39;, &#39;angles&#39;): int})</span>
<span class="sd">    &gt;&gt;&gt; schema({&#39;alpha&#39;: 30})</span>
<span class="sd">    {&#39;alpha&#39;: 30}</span>

<span class="sd">    Keys inside a same group of exclusion cannot be together, it only makes sense for dictionaries:</span>

<span class="sd">    &gt;&gt;&gt; with raises(er.MultipleInvalid, &quot;two or more values in the same group of exclusion &#39;angles&#39; @ data[&lt;angles&gt;]&quot;):</span>
<span class="sd">    ...   schema({&#39;alpha&#39;: 30, &#39;beta&#39;: 45})</span>

<span class="sd">    For example, API can provides multiple types of authentication, but only one works in the same time:</span>

<span class="sd">    &gt;&gt;&gt; msg = &#39;Please, use only one type of authentication at the same time.&#39;</span>
<span class="sd">    &gt;&gt;&gt; schema = Schema({</span>
<span class="sd">    ... Exclusive(&#39;classic&#39;, &#39;auth&#39;, msg=msg):{</span>
<span class="sd">    ...     Required(&#39;email&#39;): basestring,</span>
<span class="sd">    ...     Required(&#39;password&#39;): basestring</span>
<span class="sd">    ...     },</span>
<span class="sd">    ... Exclusive(&#39;internal&#39;, &#39;auth&#39;, msg=msg):{</span>
<span class="sd">    ...     Required(&#39;secret_key&#39;): basestring</span>
<span class="sd">    ...     },</span>
<span class="sd">    ... Exclusive(&#39;social&#39;, &#39;auth&#39;, msg=msg):{</span>
<span class="sd">    ...     Required(&#39;social_network&#39;): basestring,</span>
<span class="sd">    ...     Required(&#39;token&#39;): basestring</span>
<span class="sd">    ...     }</span>
<span class="sd">    ... })</span>

<span class="sd">    &gt;&gt;&gt; with raises(er.MultipleInvalid, &quot;Please, use only one type of authentication at the same time. @ data[&lt;auth&gt;]&quot;):</span>
<span class="sd">    ...     schema({&#39;classic&#39;: {&#39;email&#39;: &#39;foo@example.com&#39;, &#39;password&#39;: &#39;bar&#39;},</span>
<span class="sd">    ...             &#39;social&#39;: {&#39;social_network&#39;: &#39;barfoo&#39;, &#39;token&#39;: &#39;tEMp&#39;}})</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">schema</span><span class="p">,</span> <span class="n">group_of_exclusion</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Exclusive</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">schema</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="n">msg</span><span class="p">,</span>
                                        <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">group_of_exclusion</span> <span class="o">=</span> <span class="n">group_of_exclusion</span></div>


<div class="viewcode-block" id="Inclusive"><a class="viewcode-back" href="../../voluptuous.html#voluptuous.schema_builder.Inclusive">[docs]</a><span class="k">class</span> <span class="nc">Inclusive</span><span class="p">(</span><span class="n">Optional</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Mark a node in the schema as inclusive.</span>

<span class="sd">    Inclusive keys inherited from Optional:</span>

<span class="sd">    &gt;&gt;&gt; schema = Schema({</span>
<span class="sd">    ...     Inclusive(&#39;filename&#39;, &#39;file&#39;): str,</span>
<span class="sd">    ...     Inclusive(&#39;mimetype&#39;, &#39;file&#39;): str</span>
<span class="sd">    ... })</span>
<span class="sd">    &gt;&gt;&gt; data = {&#39;filename&#39;: &#39;dog.jpg&#39;, &#39;mimetype&#39;: &#39;image/jpeg&#39;}</span>
<span class="sd">    &gt;&gt;&gt; data == schema(data)</span>
<span class="sd">    True</span>

<span class="sd">    Keys inside a same group of inclusive must exist together, it only makes sense for dictionaries:</span>

<span class="sd">    &gt;&gt;&gt; with raises(er.MultipleInvalid, &quot;some but not all values in the same group of inclusion &#39;file&#39; @ data[&lt;file&gt;]&quot;):</span>
<span class="sd">    ...     schema({&#39;filename&#39;: &#39;dog.jpg&#39;})</span>

<span class="sd">    If none of the keys in the group are present, it is accepted:</span>

<span class="sd">    &gt;&gt;&gt; schema({})</span>
<span class="sd">    {}</span>

<span class="sd">    For example, API can return &#39;height&#39; and &#39;width&#39; together, but not separately.</span>

<span class="sd">    &gt;&gt;&gt; msg = &quot;Height and width must exist together&quot;</span>
<span class="sd">    &gt;&gt;&gt; schema = Schema({</span>
<span class="sd">    ...     Inclusive(&#39;height&#39;, &#39;size&#39;, msg=msg): int,</span>
<span class="sd">    ...     Inclusive(&#39;width&#39;, &#39;size&#39;, msg=msg): int</span>
<span class="sd">    ... })</span>

<span class="sd">    &gt;&gt;&gt; with raises(er.MultipleInvalid, msg + &quot; @ data[&lt;size&gt;]&quot;):</span>
<span class="sd">    ...     schema({&#39;height&#39;: 100})</span>

<span class="sd">    &gt;&gt;&gt; with raises(er.MultipleInvalid, msg + &quot; @ data[&lt;size&gt;]&quot;):</span>
<span class="sd">    ...     schema({&#39;width&#39;: 100})</span>

<span class="sd">    &gt;&gt;&gt; data = {&#39;height&#39;: 100, &#39;width&#39;: 100}</span>
<span class="sd">    &gt;&gt;&gt; data == schema(data)</span>
<span class="sd">    True</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">schema</span><span class="p">,</span> <span class="n">group_of_inclusion</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Inclusive</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">schema</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="n">msg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">group_of_inclusion</span> <span class="o">=</span> <span class="n">group_of_inclusion</span></div>


<div class="viewcode-block" id="Required"><a class="viewcode-back" href="../../voluptuous.html#voluptuous.schema_builder.Required">[docs]</a><span class="k">class</span> <span class="nc">Required</span><span class="p">(</span><span class="n">Marker</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Mark a node in the schema as being required, and optionally provide a default value.</span>

<span class="sd">    &gt;&gt;&gt; schema = Schema({Required(&#39;key&#39;): str})</span>
<span class="sd">    &gt;&gt;&gt; with raises(er.MultipleInvalid, &quot;required key not provided @ data[&#39;key&#39;]&quot;):</span>
<span class="sd">    ...   schema({})</span>

<span class="sd">    &gt;&gt;&gt; schema = Schema({Required(&#39;key&#39;, default=&#39;value&#39;): str})</span>
<span class="sd">    &gt;&gt;&gt; schema({})</span>
<span class="sd">    {&#39;key&#39;: &#39;value&#39;}</span>
<span class="sd">    &gt;&gt;&gt; schema = Schema({Required(&#39;key&#39;, default=list): list})</span>
<span class="sd">    &gt;&gt;&gt; schema({})</span>
<span class="sd">    {&#39;key&#39;: []}</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">schema</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">UNDEFINED</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Required</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">schema</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="n">msg</span><span class="p">,</span>
                                       <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default</span> <span class="o">=</span> <span class="n">default_factory</span><span class="p">(</span><span class="n">default</span><span class="p">)</span></div>


<div class="viewcode-block" id="Remove"><a class="viewcode-back" href="../../voluptuous.html#voluptuous.schema_builder.Remove">[docs]</a><span class="k">class</span> <span class="nc">Remove</span><span class="p">(</span><span class="n">Marker</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Mark a node in the schema to be removed and excluded from the validated</span>
<span class="sd">    output. Keys that fail validation will not raise ``Invalid``. Instead, these</span>
<span class="sd">    keys will be treated as extras.</span>

<span class="sd">    &gt;&gt;&gt; schema = Schema({str: int, Remove(int): str})</span>
<span class="sd">    &gt;&gt;&gt; with raises(er.MultipleInvalid, &quot;extra keys not allowed @ data[1]&quot;):</span>
<span class="sd">    ...    schema({&#39;keep&#39;: 1, 1: 1.0})</span>
<span class="sd">    &gt;&gt;&gt; schema({1: &#39;red&#39;, &#39;red&#39;: 1, 2: &#39;green&#39;})</span>
<span class="sd">    {&#39;red&#39;: 1}</span>
<span class="sd">    &gt;&gt;&gt; schema = Schema([int, Remove(float), Extra])</span>
<span class="sd">    &gt;&gt;&gt; schema([1, 2, 3, 4.0, 5, 6.0, &#39;7&#39;])</span>
<span class="sd">    [1, 2, 3, 5, &#39;7&#39;]</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Remove</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__call__</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;Remove(</span><span class="si">%r</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="p">,)</span>

    <span class="k">def</span> <span class="nf">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">object</span><span class="o">.</span><span class="n">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>


<div class="viewcode-block" id="message"><a class="viewcode-back" href="../../voluptuous.html#voluptuous.schema_builder.message">[docs]</a><span class="k">def</span> <span class="nf">message</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">cls</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convenience decorator to allow functions to provide a message.</span>

<span class="sd">    Set a default message:</span>

<span class="sd">        &gt;&gt;&gt; @message(&#39;not an integer&#39;)</span>
<span class="sd">        ... def isint(v):</span>
<span class="sd">        ...   return int(v)</span>

<span class="sd">        &gt;&gt;&gt; validate = Schema(isint())</span>
<span class="sd">        &gt;&gt;&gt; with raises(er.MultipleInvalid, &#39;not an integer&#39;):</span>
<span class="sd">        ...   validate(&#39;a&#39;)</span>

<span class="sd">    The message can be overridden on a per validator basis:</span>

<span class="sd">        &gt;&gt;&gt; validate = Schema(isint(&#39;bad&#39;))</span>
<span class="sd">        &gt;&gt;&gt; with raises(er.MultipleInvalid, &#39;bad&#39;):</span>
<span class="sd">        ...   validate(&#39;a&#39;)</span>

<span class="sd">    The class thrown too:</span>

<span class="sd">        &gt;&gt;&gt; class IntegerInvalid(er.Invalid): pass</span>
<span class="sd">        &gt;&gt;&gt; validate = Schema(isint(&#39;bad&#39;, clsoverride=IntegerInvalid))</span>
<span class="sd">        &gt;&gt;&gt; try:</span>
<span class="sd">        ...  validate(&#39;a&#39;)</span>
<span class="sd">        ... except er.MultipleInvalid as e:</span>
<span class="sd">        ...   assert isinstance(e.errors[0], IntegerInvalid)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">cls</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">er</span><span class="o">.</span><span class="n">Invalid</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">er</span><span class="o">.</span><span class="n">SchemaError</span><span class="p">(</span><span class="s2">&quot;message can only use subclases of Invalid as custom class&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
        <span class="nd">@wraps</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">check</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">clsoverride</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
            <span class="nd">@wraps</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="p">(</span><span class="n">clsoverride</span> <span class="ow">or</span> <span class="n">cls</span> <span class="ow">or</span> <span class="n">er</span><span class="o">.</span><span class="n">ValueInvalid</span><span class="p">)(</span><span class="n">msg</span> <span class="ow">or</span> <span class="n">default</span> <span class="ow">or</span> <span class="s1">&#39;invalid value&#39;</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">wrapper</span>

        <span class="k">return</span> <span class="n">check</span>

    <span class="k">return</span> <span class="n">decorator</span></div>


<span class="k">def</span> <span class="nf">_args_to_dict</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns argument names as values as key-value pairs.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">arg_count</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">__code__</span><span class="o">.</span><span class="n">co_argcount</span>
        <span class="n">arg_names</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">__code__</span><span class="o">.</span><span class="n">co_varnames</span><span class="p">[:</span><span class="n">arg_count</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">arg_count</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">func_code</span><span class="o">.</span><span class="n">co_argcount</span>
        <span class="n">arg_names</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">func_code</span><span class="o">.</span><span class="n">co_varnames</span><span class="p">[:</span><span class="n">arg_count</span><span class="p">]</span>

    <span class="n">arg_value_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">arguments</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">arg_name</span><span class="p">,</span> <span class="n">arg_value_list</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                     <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">arg_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">arg_names</span><span class="p">)</span>
                     <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">arg_value_list</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">arguments</span>


<span class="k">def</span> <span class="nf">_merge_args_with_kwargs</span><span class="p">(</span><span class="n">args_dict</span><span class="p">,</span> <span class="n">kwargs_dict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Merge args with kwargs.&quot;&quot;&quot;</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">args_dict</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">ret</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs_dict</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ret</span>


<div class="viewcode-block" id="validate"><a class="viewcode-back" href="../../voluptuous.html#voluptuous.schema_builder.validate">[docs]</a><span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Decorator for validating arguments of a function against a given schema.</span>

<span class="sd">    Set restrictions for arguments:</span>

<span class="sd">        &gt;&gt;&gt; @validate(arg1=int, arg2=int)</span>
<span class="sd">        ... def foo(arg1, arg2):</span>
<span class="sd">        ...   return arg1 * arg2</span>

<span class="sd">    Set restriction for returned value:</span>

<span class="sd">        &gt;&gt;&gt; @validate(arg=int, __return__=int)</span>
<span class="sd">        ... def bar(arg1):</span>
<span class="sd">        ...   return arg1 * 2</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">RETURNS_KEY</span> <span class="o">=</span> <span class="s1">&#39;__return__&#39;</span>

    <span class="k">def</span> <span class="nf">validate_schema_decorator</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>

        <span class="n">returns_defined</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">returns</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="n">schema_args_dict</span> <span class="o">=</span> <span class="n">_args_to_dict</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
        <span class="n">schema_arguments</span> <span class="o">=</span> <span class="n">_merge_args_with_kwargs</span><span class="p">(</span><span class="n">schema_args_dict</span><span class="p">,</span> <span class="n">kw</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">RETURNS_KEY</span> <span class="ow">in</span> <span class="n">schema_arguments</span><span class="p">:</span>
            <span class="n">returns_defined</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">returns</span> <span class="o">=</span> <span class="n">schema_arguments</span><span class="p">[</span><span class="n">RETURNS_KEY</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">schema_arguments</span><span class="p">[</span><span class="n">RETURNS_KEY</span><span class="p">]</span>

        <span class="n">input_schema</span> <span class="o">=</span> <span class="p">(</span><span class="n">Schema</span><span class="p">(</span><span class="n">schema_arguments</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="n">ALLOW_EXTRA</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">schema_arguments</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">)</span>
        <span class="n">output_schema</span> <span class="o">=</span> <span class="n">Schema</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span> <span class="k">if</span> <span class="n">returns_defined</span> <span class="k">else</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span>

        <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">func_wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">args_dict</span> <span class="o">=</span> <span class="n">_args_to_dict</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
            <span class="n">arguments</span> <span class="o">=</span> <span class="n">_merge_args_with_kwargs</span><span class="p">(</span><span class="n">args_dict</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
            <span class="n">validated_arguments</span> <span class="o">=</span> <span class="n">input_schema</span><span class="p">(</span><span class="n">arguments</span><span class="p">)</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">**</span><span class="n">validated_arguments</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">output_schema</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">func_wrapper</span>

    <span class="k">return</span> <span class="n">validate_schema_decorator</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2016, Alec Thomas.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.4.4</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.9</a>
      
    </div>

    

    
  </body>
</html>